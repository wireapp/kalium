name: "Android Tests"

on:
    pull_request:
        types: [ opened, synchronize ] # Don't rerun on `edited` to save time

concurrency:
    group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
    cancel-in-progress: true

jobs:
    gradle-run-tests:
        runs-on: macos-latest
        strategy:
            matrix:
                api-level: [30]

        steps:
            - name: Checkout
              uses: actions/checkout@v3
              with:
                  fetch-depth: 0

            - name: Set up JDK 11
              uses: actions/setup-java@v3
              with:
                  java-version: '11'
                  distribution: 'adopt'

            - name: Gradle Setup
              uses: gradle/gradle-build-action@v2

            - name: Validate Gradle wrapper
              uses: gradle/wrapper-validation-action@e6e38bacfdf1a337459f332974bb2327a31aaf4b

            # Checks for changes in the top-level gradle settings or buildSrc
            - name: Identify build configuration changes
              id: identify-build-configuration-changes
              uses: tj-actions/changed-files@v35
              with:
                  files: |
                      /*.gradle.*
                      /gradle/*.gradle.*
                      buildSrc/src/**
                      *.versions.toml

            # TODO: RE-ENABLE AFTER TESTING CI SETUP
            - name: Build the samples
              if: ${{ false }}
              env:
                  GITHUB_USER: ${{ github.actor }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  ./gradlew :samples:compileDebugSources

            - name: AVD cache
              uses: actions/cache@v3
              id: avd-cache
              with:
                  path: |
                      ~/.android/avd/*
                      ~/.android/adb*
                  key: avd-${{ matrix.api-level }}

            - name: Create AVD and generate snapshot for caching
              if: steps.avd-cache.outputs.cache-hit != 'true'
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: ${{ matrix.api-level }}
                  force-avd-creation: false
                  target: google_apis
                  emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
                  disable-animations: false
                  script: echo "Generated AVD snapshot for caching."

            # If any Gradle file was modified, run tests on ALL modules
            - name: Android Tests (All Modules)
              id: test-all-modules
              if: steps.identify-build-configuration-changes.outputs.any_modified == 'true'
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: ${{ matrix.api-level }}
                  target: google_apis
                  script: ./gradlew connectedDebugAndroidTest
              env:
                  GITHUB_USER: ${{ github.actor }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            # Only run this if the previous step was skipped
            - name: Android Tests (Affected Modules)
              if: steps.test-all-modules.outcome == 'skipped'
              uses: reactivecircus/android-emulator-runner@v2
              with:
                  api-level: ${{ matrix.api-level }}
                  target: google_apis
                  script: ./gradlew connectedAndroidOnlyAffectedTest
              env:
                  GITHUB_USER: ${{ github.actor }}
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Archive Test Reports
              if: always()
              uses: actions/upload-artifact@v3
              with:
                  name: test-reports
                  path: ./**/build/reports/tests/**

            - name: Publish Unit Test Results
              uses: EnricoMi/publish-unit-test-result-action/composite@v1.25
              if: always()
              with:
                  files: |
                      **/build/test-results/**/*.xml
                      **/build/outputs/androidTest-results/**/*.xml

            - name: Cleanup Gradle Cache
                # Remove some files from the Gradle cache, so they aren't cached by GitHub Actions.
                # Restoring these files from a GitHub Actions cache might cause problems for future builds.
              run: |
                  rm -f ~/.gradle/caches/modules-2/modules-2.lock
                  rm -f ~/.gradle/caches/modules-2/gc.properties
